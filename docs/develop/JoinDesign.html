
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>HashJoin Translator design &#8212; Cider 1.0 documentation</title>
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="../index.html">Cider 1.0 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="hashjoin-translator-design">
<h1>HashJoin Translator design<a class="headerlink" href="#hashjoin-translator-design" title="Permalink to this headline">¶</a></h1>
<div class="section" id="api-introduction">
<h2>API Introduction<a class="headerlink" href="#api-introduction" title="Permalink to this headline">¶</a></h2>
<div class="section" id="void-hashjointranslator-codegen">
<h3>void HashJoinTranslator::codegen()<a class="headerlink" href="#void-hashjointranslator-codegen" title="Permalink to this headline">¶</a></h3>
<div class="section" id="get-join-quals-join-type-build-table-map-from-hashjoinnode">
<h4>1. get join_quals, join_type, build_table_map from HashJoinNode<a class="headerlink" href="#get-join-quals-join-type-build-table-map-from-hashjoinnode" title="Permalink to this headline">¶</a></h4>
<p>build_table_map:std::map&lt;ExprPtr, size_t&gt;, record its expr and offset in batch</p>
</div>
<div class="section" id="traverse-join-quals-to-get-join-key">
<h4>2. traverse join_quals to get join_key<a class="headerlink" href="#traverse-join-quals-to-get-join-key" title="Permalink to this headline">¶</a></h4>
<p>void traverse(..): traverse join_quals expr tree to get join key value and null vector</p>
</div>
<div class="section" id="pack-join-key-value-join-key-null-maybe-multi-key">
<h4>3. pack join_key_value, join_key_null (maybe multi key)<a class="headerlink" href="#pack-join-key-value-join-key-null-maybe-multi-key" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="register-buffer-join-res-buffer-to-reserve-the-join-result">
<h4>4. register buffer(join_res_buffer) to reserve the join result<a class="headerlink" href="#register-buffer-join-res-buffer-to-reserve-the-join-result" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="register-hashtable-hashtable">
<h4>5. register hashTable (hashtable)<a class="headerlink" href="#register-hashtable-hashtable" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="call-look-up-value-by-key-function">
<h4>6. call look_up_value_by_key function<a class="headerlink" href="#call-look-up-value-by-key-function" title="Permalink to this headline">¶</a></h4>
<p>get the join result(store the result in join_res_buffer, return result rows)
join result type:vector&lt;Batch*, batch_offset&gt;</p>
</div>
<div class="section" id="loop-builder-the-loop-to-traverse-join-results-row-id-as-the-index">
<h4>7. loop_builder(the loop to traverse join results, row_id as the index)<a class="headerlink" href="#loop-builder-the-loop-to-traverse-join-results-row-id-as-the-index" title="Permalink to this headline">¶</a></h4>
<p>switch(join_type)</p>
<blockquote>
<div><ul class="simple">
<li><cite>7.1 inner_join</cite>:</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="p">(</span><span class="n">row_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">row_index</span> <span class="o">&lt;</span> <span class="n">join_res_len</span><span class="p">;</span> <span class="n">row_index</span><span class="o">++</span><span class="p">){</span>
    <span class="n">call</span> <span class="n">join_probe</span><span class="p">()</span> <span class="p">(</span><span class="k">as</span> <span class="n">introduction</span> <span class="n">below</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><cite>7.1 left_join</cite>:</li>
</ul>
<p>First, maintain the number of cycles through row_index, first set the value of the expr to the default value (value = 0, null=true),
if join_res_len = 0, that is the data in the probe table but not in the build table, take the default value, Jump out of the loop and enter the next op,
if it is not 0, then run joinProbe() to get the corresponding real value</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="p">(</span><span class="n">join_res_len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="n">row_index</span><span class="o">++</span><span class="p">;</span> <span class="p">}</span>
<span class="k">for</span><span class="p">(</span><span class="n">row_index</span><span class="p">;</span> <span class="n">row_index</span><span class="o">&lt;=</span><span class="n">join_res_len</span><span class="p">;</span><span class="n">row_index</span><span class="o">++</span><span class="p">){</span>
    <span class="k">for</span><span class="p">(</span><span class="n">auto</span> <span class="n">item</span><span class="p">:</span> <span class="n">build_table_map</span><span class="o">.</span><span class="n">exprs</span><span class="p">){</span>
        <span class="n">setDefaultValue</span><span class="p">(</span><span class="k">for</span> <span class="n">left</span> <span class="n">join</span><span class="p">,</span> <span class="k">if</span> <span class="n">join_res_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">also</span> <span class="n">needs</span> <span class="n">output</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">join_res_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
        <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">joinProbe</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p>in <code class="docutils literal notranslate"><span class="pre">ExprDefaultValueSetter</span></code>, the variable <code class="docutils literal notranslate"><span class="pre">std::map&lt;ExprPtr,</span> <span class="pre">std::vector&lt;JITValuePointer&gt;&gt;&amp;</span> <span class="pre">expr_map_</span></code> is used to preseve
the expr and its corresponding default buffer value, Note that we used <code class="docutils literal notranslate"><span class="pre">createVariable()</span></code>, it will work in <code class="docutils literal notranslate"><span class="pre">joinProbe()</span></code> JoinType::LEFT</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">expr_map_</span><span class="o">.</span><span class="n">insert</span><span class="p">({</span><span class="n">expr_</span><span class="p">,</span> <span class="p">{</span><span class="n">null_init</span><span class="p">,</span> <span class="n">val_init</span><span class="p">}});</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="void-joinprobe">
<h3>void joinProbe()<a class="headerlink" href="#void-joinprobe" title="Permalink to this headline">¶</a></h3>
<div class="section" id="get-res-array-batch-res-row-id-batch-offset-from-join-res-buffer">
<h4>1. get res_array(batch*), res_row_id(batch_offset) from join_res_buffer<a class="headerlink" href="#get-res-array-batch-res-row-id-batch-offset-from-join-res-buffer" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="traverse-build-table-map-to-get-the-array-child-and-get-multi-buffer-value">
<h4>2. traverse build_table_map to get the array-&gt;child, and get multi buffer value<a class="headerlink" href="#traverse-build-table-map-to-get-the-array-child-and-get-multi-buffer-value" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="buildtablereader-reader">
<h4>3. BuildTableReader reader()<a class="headerlink" href="#buildtablereader-reader" title="Permalink to this headline">¶</a></h4>
<p>use the BuildTableReader to to populate the value of the corresponding column of the build table, BuildTableReader code structure is similar to ColumnToRowReader</p>
</div>
<div class="section" id="join-type-jointype-left">
<h4>4. join_type == JoinType::LEFT<a class="headerlink" href="#join-type-jointype-left" title="Permalink to this headline">¶</a></h4>
<p>for Left join type, we created the continue LLVM BasicBlock.
and in LLVM code, two parallel basicBlock cannot call each other’s internally defined local variables,
so the pre-defined variables are used here to get the result after read and save them as variables</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">expr_val</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="n">expr_val</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">vector</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
</div>
<div class="section" id="notes">
<h2>Notes<a class="headerlink" href="#notes" title="Permalink to this headline">¶</a></h2>
<p>will add later</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">HashJoin Translator design</a><ul>
<li><a class="reference internal" href="#api-introduction">API Introduction</a><ul>
<li><a class="reference internal" href="#void-hashjointranslator-codegen">void HashJoinTranslator::codegen()</a><ul>
<li><a class="reference internal" href="#get-join-quals-join-type-build-table-map-from-hashjoinnode">1. get join_quals, join_type, build_table_map from HashJoinNode</a></li>
<li><a class="reference internal" href="#traverse-join-quals-to-get-join-key">2. traverse join_quals to get join_key</a></li>
<li><a class="reference internal" href="#pack-join-key-value-join-key-null-maybe-multi-key">3. pack join_key_value, join_key_null (maybe multi key)</a></li>
<li><a class="reference internal" href="#register-buffer-join-res-buffer-to-reserve-the-join-result">4. register buffer(join_res_buffer) to reserve the join result</a></li>
<li><a class="reference internal" href="#register-hashtable-hashtable">5. register hashTable (hashtable)</a></li>
<li><a class="reference internal" href="#call-look-up-value-by-key-function">6. call look_up_value_by_key function</a></li>
<li><a class="reference internal" href="#loop-builder-the-loop-to-traverse-join-results-row-id-as-the-index">7. loop_builder(the loop to traverse join results, row_id as the index)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#void-joinprobe">void joinProbe()</a><ul>
<li><a class="reference internal" href="#get-res-array-batch-res-row-id-batch-offset-from-join-res-buffer">1. get res_array(batch*), res_row_id(batch_offset) from join_res_buffer</a></li>
<li><a class="reference internal" href="#traverse-build-table-map-to-get-the-array-child-and-get-multi-buffer-value">2. traverse build_table_map to get the array-&gt;child, and get multi buffer value</a></li>
<li><a class="reference internal" href="#buildtablereader-reader">3. BuildTableReader reader()</a></li>
<li><a class="reference internal" href="#join-type-jointype-left">4. join_type == JoinType::LEFT</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#notes">Notes</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/develop/JoinDesign.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="../index.html">Cider 1.0 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2022, Intel.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.
    </div>
  </body>
</html>