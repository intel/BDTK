
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Intel Codec Library User Guide &#8212; Cider 1.0 documentation</title>
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Expression Evaluation Module Introduction" href="expr-eval-module.html" />
    <link rel="prev" title="Modules" href="../modules.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="expr-eval-module.html" title="Expression Evaluation Module Introduction"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../modules.html" title="Modules"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Cider 1.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../user.html" >User Guide</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../modules.html" accesskey="U">Modules</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="intel-codec-library-user-guide">
<span id="icl-user-guide-reference-link"></span><h1>Intel Codec Library User Guide<a class="headerlink" href="#intel-codec-library-user-guide" title="Permalink to this headline">¶</a></h1>
<div class="section" id="module-description">
<span id="icl-description-reference-link"></span><h2>Module description<a class="headerlink" href="#module-description" title="Permalink to this headline">¶</a></h2>
<p>The Intel Codec Library (ICL) provides compression and decompression library for Apache Hadoop/Spark/Parquet/Arrow to make use of the hardware accelerator, and/or software for compression/decompression. It not only supports the use of Intel hardware accelerator such as QAT and IAA to accelerate the deflate-compatible data compression algorithm but also supports the use of Intel optimized software solutions such as ISA-L(Intel Intelligent Storage Acceleration Library) and IPP(Intel Integrated Performance Primitives Library) which utilize the latest CPU features (such as AVX-512) to accelerate the data compression.</p>
<p>Currently the Intel Codec Library supports the following backends:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">IGZIP</span></code> - use ISA-L software to accelerate the compression</li>
<li><code class="docutils literal notranslate"><span class="pre">QAT</span></code> - use QAT hardware accelerator to accelerate the compression</li>
<li><code class="docutils literal notranslate"><span class="pre">QPL</span></code> - use IAA hardware accelerator to accelerate the compression</li>
<li><code class="docutils literal notranslate"><span class="pre">IPP</span></code> - use IPP software to accelerate the compression. <strong>Note:</strong> Please refer <a class="reference external" href="https://www.intel.com/content/www/us/en/developer/articles/troubleshooting/oneapi-commercial-faq.html">FAQ</a> for IPP commercial products support.</li>
</ul>
<p>Please check the table below to see which compression codecs are supported by each backend.</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="40%" />
<col width="30%" />
<col width="30%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">&#160;</th>
<th class="head">Deflate</th>
<th class="head">LZ4</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>IGZIP</td>
<td>Y</td>
<td>X</td>
</tr>
<tr class="row-odd"><td>QAT</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr class="row-even"><td>QPL</td>
<td>Y</td>
<td>X</td>
</tr>
<tr class="row-odd"><td>IPP</td>
<td>Y</td>
<td>Y</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="sdk-api">
<span id="icl-sdk-api-reference-link"></span><h2>SDK API<a class="headerlink" href="#sdk-api" title="Permalink to this headline">¶</a></h2>
<p>The class diagram of Intel Codec Library is shown below:</p>
<img alt="../../_images/ICL-class.png" src="../../_images/ICL-class.png" />
</div>
<div class="section" id="building-the-library">
<h2>Building the Library<a class="headerlink" href="#building-the-library" title="Permalink to this headline">¶</a></h2>
<div class="section" id="prerequisites">
<h3>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h3>
<p>Before building Intel Codec Library, install and set up the following tools:</p>
<ul class="simple">
<li>nasm 2.14.0 or higher (e.g., can be obtained from <a class="reference external" href="https://www.nasm.us">https://www.nasm.us</a>)</li>
<li>A C++17-enabled compiler. GCC 8 and higher should be sufficient</li>
<li>CMake version 3.16 or higher</li>
</ul>
</div>
<div class="section" id="build">
<h3>Build<a class="headerlink" href="#build" title="Permalink to this headline">¶</a></h3>
<p>To build Intel Codec Library, complete the following step:</p>
<ol class="arabic">
<li><p class="first">Get the Source using the following command:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>git clone --recursive https://github.com/intel/BDTK.git &lt;BDTK&gt;
</pre></div>
</div>
</li>
<li><p class="first">Build the library by executing the following commands in <code class="docutils literal notranslate"><span class="pre">&lt;BDTK&gt;</span></code></p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>mkdir build
<span class="nb">cd</span> build
cmake -DCMAKE_BUILD_TYPE<span class="o">=</span>Release -DBDTK_ENABLE_ICL<span class="o">=</span>ON -DBDTK_ENABLE_CIDER<span class="o">=</span>OFF ../cpp
cmake --build .
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You need to set more options to customize your build. See <a class="reference internal" href="#icl-build-options-reference-link"><span class="std std-ref">Build Options</span></a> for details.</p>
</div>
</li>
</ol>
</div>
<div class="section" id="build-options">
<span id="icl-build-options-reference-link"></span><h3>Build Options<a class="headerlink" href="#build-options" title="Permalink to this headline">¶</a></h3>
<p>By default, the C++ build system creates a fairly minimal build. Intel Codec Library supports the following build options which you can configure into build system by passing boolean flags to <code class="docutils literal notranslate"><span class="pre">cmake</span></code>.</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">-DICL_WITH_IGZIP=[ON|OFF]</span></code> - Build ICL with IGZIP backend (<code class="docutils literal notranslate"><span class="pre">ON</span></code> by default).</li>
<li><code class="docutils literal notranslate"><span class="pre">-DICL_WITH_QAT=[ON|OFF]</span></code> - Build ICL with QAT backend (<code class="docutils literal notranslate"><span class="pre">OFF</span></code> by default).</li>
<li><code class="docutils literal notranslate"><span class="pre">-DICL_WITH_QPL=[ON|OFF]</span></code> - Build ICL with QPL backend (<code class="docutils literal notranslate"><span class="pre">OFF</span></code> by default).</li>
<li><code class="docutils literal notranslate"><span class="pre">-DICL_WITH_IPP=[ON|OFF]</span></code> - Build ICL with IPP backend (<code class="docutils literal notranslate"><span class="pre">OFF</span></code> by default).</li>
<li><code class="docutils literal notranslate"><span class="pre">-DICL_BUILD_TESTS=[ON|OFF]</span></code> - Build the ICL googletest unit tests (<code class="docutils literal notranslate"><span class="pre">OFF</span></code> by default).</li>
<li><code class="docutils literal notranslate"><span class="pre">-DICL_BUILD_BENCHMARKS=[ON|OFF]</span></code> - Build the ICL micro benchmarks (<code class="docutils literal notranslate"><span class="pre">OFF</span></code> by default).</li>
</ul>
</div>
<div class="section" id="modular-build-target">
<h3>Modular Build Target<a class="headerlink" href="#modular-build-target" title="Permalink to this headline">¶</a></h3>
<p>Since there are several suport backends of the ICL, we have provided modular Make target for building each supported backends, group of unit tests and benchmarks:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">icl</span></code> for ICL libraries which enable only <em>igzip</em> backend support.</li>
<li><code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">icl-qat</span></code> for ICL libraries which enable only <em>qat</em> backend support.</li>
<li><code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">icl-qpl</span></code> for ICL libraries which enable only <em>qpl</em> backend support.</li>
<li><code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">icl-ipp</span></code> for ICL libraries which enable only <em>ipp</em> backend support.</li>
<li><code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">icl-all</span></code> for ICL libraries which enable all supported backends.</li>
<li><code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">icl-test</span></code> for ICL libraries which enable unit tests for all supported backends.</li>
<li><code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">icl-benchmark</span></code> for ICL libraries which enable benchmark for all supported backends.</li>
</ul>
</div>
<div class="section" id="additional-requirements-for-qat-backend">
<h3>Additional requirements for QAT backend<a class="headerlink" href="#additional-requirements-for-qat-backend" title="Permalink to this headline">¶</a></h3>
<p>QAT backend is based on <a class="reference external" href="https://www.intel.com/content/www/us/en/search.html?ws=idsa-default#q=quickassist&amp;sort=relevancy&amp;f:&#64;tabfilter=[Downloads]">QAT driver</a> and <a class="reference external" href="https://github.com/intel/QATzip">QATzip library</a>. Please manually download QAT driver for your system and follow its README to build and install QAT driver. In addition to install the QAT driver you also need follow QATZip library README to manually build and install the QATZip library.</p>
<p>After installing the QAT driver and QATZip library, you need to do some confiugration on the QAT to enable QAT backend at run-time.</p>
<ol class="arabic">
<li><p class="first">Enable huge page</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="m">1024</span> &gt; /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages
rmmod usdm_drv
insmod <span class="nv">$ICP_ROOT</span>/build/usdm_drv.ko <span class="nv">max_huge_pages</span><span class="o">=</span><span class="m">1024</span> <span class="nv">max_huge_pages_per_process</span><span class="o">=</span><span class="m">48</span>
</pre></div>
</div>
</li>
<li><p class="first">Update configuration files</p>
<p>You need have the right QAT configuration files at the directory of <code class="docutils literal notranslate"><span class="pre">/etc</span></code>. Please see <a class="reference external" href="https://www.intel.com/content/www/us/en/content-details/743913/intel-quickassist-technology-intel-qat-software-for-linux-programmers-guide-hardware-version-2-0.html">QAT Programmer’s Guide</a>  for how to configure QAT. We provide an example <a class="reference external" href="https://github.com/intel/BDTK/src/compression/resource/qat/4xxx_dev0.conf">configuration file</a> for your reference. This configuration file sets up to 4 processes that can bind to 1 QAT, and each process can use up to 16 QAT DC instances. Please modify this configuration file according to your requirements and copy the configuration file to directory of <code class="docutils literal notranslate"><span class="pre">/etc/</span></code>.</p>
</li>
<li><p class="first">Restart QAT driver</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>adf_ctrl restart
</pre></div>
</div>
<p>You can check the QAT hardware status use the below command:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>adf_ctrl status
</pre></div>
</div>
<p>If all goes well, the output should be like:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>There is <span class="m">8</span> QAT acceleration device<span class="o">(</span>s<span class="o">)</span> in the system:
qat_dev0 - type: 4xxx,  inst_id: <span class="m">0</span>,  node_id: <span class="m">0</span>,  bsf: <span class="m">0000</span>:6b:00.0,  <span class="c1">#accel: 1 #engines: 9 state: up</span>
qat_dev1 - type: 4xxx,  inst_id: <span class="m">1</span>,  node_id: <span class="m">1</span>,  bsf: <span class="m">0000</span>:70:00.0,  <span class="c1">#accel: 1 #engines: 9 state: up</span>
qat_dev2 - type: 4xxx,  inst_id: <span class="m">2</span>,  node_id: <span class="m">2</span>,  bsf: <span class="m">0000</span>:75:00.0,  <span class="c1">#accel: 1 #engines: 9 state: up</span>
qat_dev3 - type: 4xxx,  inst_id: <span class="m">3</span>,  node_id: <span class="m">3</span>,  bsf: <span class="m">0000</span>:7a:00.0,  <span class="c1">#accel: 1 #engines: 9 state: up</span>
qat_dev4 - type: 4xxx,  inst_id: <span class="m">4</span>,  node_id: <span class="m">4</span>,  bsf: <span class="m">0000</span>:e8:00.0,  <span class="c1">#accel: 1 #engines: 9 state: up</span>
qat_dev5 - type: 4xxx,  inst_id: <span class="m">5</span>,  node_id: <span class="m">5</span>,  bsf: <span class="m">0000</span>:ed:00.0,  <span class="c1">#accel: 1 #engines: 9 state: up</span>
qat_dev6 - type: 4xxx,  inst_id: <span class="m">6</span>,  node_id: <span class="m">6</span>,  bsf: <span class="m">0000</span>:f2:00.0,  <span class="c1">#accel: 1 #engines: 9 state: up</span>
qat_dev7 - type: 4xxx,  inst_id: <span class="m">7</span>,  node_id: <span class="m">7</span>,  bsf: <span class="m">0000</span>:f7:00.0,  <span class="c1">#accel: 1 #engines: 9 state: up</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="simple">
<li>For non-root user, you nedd <code class="docutils literal notranslate"><span class="pre">add</span> <span class="pre">Non-root</span> <span class="pre">user</span> <span class="pre">to</span> <span class="pre">qat</span> <span class="pre">group</span></code></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>sudo usermod -g qat username <span class="c1"># need to relogin</span>
or
sudo newgrp qat  <span class="c1"># effective immediately</span>
</pre></div>
</div>
<ul class="last simple">
<li>The above additional requirements are not required when building the Intel Codec Library but only at runtime.</li>
</ul>
</div>
</li>
</ol>
<p>For more Intel® QuickAssist Technology resources go to <a class="reference external" href="https://developer.intel.com/quickassist">Intel® QuickAssist Technology (Intel® QAT)</a>.</p>
</div>
<div class="section" id="additional-requirements-for-qpl-backend">
<h3>Additional requirements for QPL backend<a class="headerlink" href="#additional-requirements-for-qpl-backend" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">libaccel-config</span></code> library version 3.2 or higher is required for building Intel Codec Library with QPL support. Refer to <a class="reference external" href="https://github.com/intel/idxd-config/">accel-config releases</a> for how to install.</p>
</div>
<div class="section" id="additional-requirements-for-ipp-backend">
<h3>Additional requirements for IPP backend<a class="headerlink" href="#additional-requirements-for-ipp-backend" title="Permalink to this headline">¶</a></h3>
<p>To be added</p>
</div>
</div>
<div class="section" id="how-to-use-intel-codec-library">
<span id="icl-how-to-use-the-library-reference-link"></span><h2>How to use Intel Codec Library<a class="headerlink" href="#how-to-use-intel-codec-library" title="Permalink to this headline">¶</a></h2>
<p>We provided several ways to use Intel Codec Library:</p>
<ul class="simple">
<li>ICL C++ API</li>
<li>ICL JAVA API</li>
<li>ICL <a class="reference external" href="https://github.com/apache/arrow/blob/master/cpp/src/arrow/util/compression.h">Arrow Compression Codec API</a></li>
</ul>
<div class="section" id="icl-c-api">
<h3>ICL C++ API<a class="headerlink" href="#icl-c-api" title="Permalink to this headline">¶</a></h3>
<p>Intel Codec Library provides C++ API that the end users can directly call the C++ API to integrate into their own applications.</p>
<p>Let’s walk through the below example that compresses and decompresses data with <cite>igzip</cite> backend with compression leve one to learn the basic workflow of Intel Codec Library C++ API.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;icl/icl.h&quot;</span><span class="cp"></span>

<span class="k">auto</span> <span class="n">codec</span> <span class="o">=</span> <span class="n">IclCompressionCodec</span><span class="o">::</span><span class="n">MakeIclCompressionCodec</span><span class="p">(</span><span class="s">&quot;igzip&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">max_compressed_len</span> <span class="o">=</span>
   <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">MaxCompressedLen</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">()));</span>

<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span> <span class="n">compressed</span><span class="p">(</span><span class="n">max_compressed_len</span><span class="p">);</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span> <span class="n">decompressed</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>

<span class="kt">int64_t</span> <span class="n">actual_size</span> <span class="o">=</span>
   <span class="n">codec</span><span class="o">-&gt;</span><span class="n">Compress</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">max_compressed_len</span><span class="p">,</span> <span class="n">compressed</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>
<span class="n">compressed</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">actual_size</span><span class="p">);</span>

<span class="kt">int64_t</span> <span class="n">actual_decompressed_size</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">Decompress</span><span class="p">(</span>
   <span class="n">compressed</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">compressed</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">decompressed</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">decompressed</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>
</pre></div>
</div>
<p>To work with Intel Codec Library C++ API, the application will need to:</p>
<ol class="arabic simple">
<li>The application only needs to include one header file <code class="docutils literal notranslate"><span class="pre">icl/icl.h</span></code>, which specifies the prototypes of all the functions.</li>
<li>Call <cite>IclCompressionCodec::MakeIclCompressionCodec()</cite> to create the instance of IclCompressionCodec, you can pass the required underlying codec and the compression level as parameters to this function.</li>
<li>Call <cite>MaxCompressedLen()</cite> to query the required compressed buffer size</li>
<li>Allocate compressed buffer according to the returned value of step 3.</li>
<li>Call <cite>Compress()</cite> to perform a compression operation for the input data buffer and return the actual compressed size.</li>
<li>Or call <cite>Decompress()</cite> to perform a decompression operation.</li>
<li>Free resources.</li>
</ol>
</div>
<div class="section" id="icl-java-api">
<h3>ICL JAVA API<a class="headerlink" href="#icl-java-api" title="Permalink to this headline">¶</a></h3>
<p>To Be Added.</p>
</div>
<div class="section" id="icl-arrow-compression-codec-api">
<span id="icl-arrow-reference-link"></span><h3>ICL Arrow Compression Codec API<a class="headerlink" href="#icl-arrow-compression-codec-api" title="Permalink to this headline">¶</a></h3>
<p>We also provides an Arrow patch that enable the Arrow Compression Codec to leverage the Intel Codec Library to accelerate the Arrow GzipCodec. Softwares(e.g., the native parquet reader, the Arrow IPC, the Arrow Flight etc.) that use Arrow Compression Codec can get performance boost without any code modify and simply replacing the Arrow library.</p>
<p>To use Arrow Compression Codec with Intel Codec Library, users need rebuild Arrow following the below guide:</p>
<ol class="arabic">
<li><p class="first">Build Intel Codec Library using the following command:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>make icl
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="last simple">
<li>Please see <span class="xref std std-ref">icl_building_the_library_reference_link</span> for how to customize your build and enable required codec.</li>
<li>Please make sure to turn off the option <code class="docutils literal notranslate"><span class="pre">-DICL_BUILD_TESTS=OFF</span></code> and <code class="docutils literal notranslate"><span class="pre">-DICL_BUILD_BENCHMARKS=OFF</span></code> when build</li>
<li>Please manually copy <cite>icl_codec.h</cite> and <cite>libicl_codec.a</cite> to your search path for example <cite>/usr/local/include</cite> and <cite>/usr/local/lib</cite> when build arrow in the below step</li>
</ul>
</div>
</li>
<li><p class="first">Download the Arrow patch <a class="reference external" href="https://github.com/intel/BDTK/blob/main/cpp/resource/0001-Add-ICL-support.patch">here</a>.</p>
</li>
<li><p class="first">Get the Arrow Source using the following command:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>git clone -b apache-arrow-10.0.0 https://github.com/apache/arrow.git
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Currently, we only provide the patch for Arrow version <em>10.0.0</em>, other versions please make corresponding modifications based on this patch.</p>
</div>
</li>
<li><p class="first">Apply the patch using the following command:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> arrow
git am <span class="m">0001</span>-Add-ICL-support.patch
</pre></div>
</div>
</li>
<li><p class="first">Build Arrow with <code class="docutils literal notranslate"><span class="pre">-DARROW_WITH_ICL=ON</span></code> option</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="last simple">
<li>Please ref <a class="reference external" href="https://arrow.apache.org/docs/developers/cpp/building.html">here</a> for how to build arrow.</li>
</ul>
</div>
</li>
<li><p class="first">Set the environment <code class="docutils literal notranslate"><span class="pre">GZIP_BACKEND</span></code> to enable Intel Codec Library, for example, to enable <code class="docutils literal notranslate"><span class="pre">igzip</span></code> backend, you can set <code class="docutils literal notranslate"><span class="pre">GZIP_BACKEND</span></code> with the following command:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">GZIP_BACKEND</span><span class="o">=</span><span class="s2">&quot;igzip&quot;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="last simple">
<li>The supported <code class="docutils literal notranslate"><span class="pre">GZIP_BACKEND</span></code> can be set  to one of <code class="docutils literal notranslate"><span class="pre">igzip</span></code>, <code class="docutils literal notranslate"><span class="pre">qat</span></code>, <code class="docutils literal notranslate"><span class="pre">qpl</span></code>, or <code class="docutils literal notranslate"><span class="pre">ipp</span></code></li>
<li>The Arrow Codec must be set to <code class="docutils literal notranslate"><span class="pre">Compression::GZIP</span></code></li>
</ul>
</div>
</li>
<li><p class="first">Use Arrow Codec API as below example:</p>
</li>
</ol>
<blockquote>
<div><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;arrow/util/compression.h&quot;</span><span class="cp"></span>

<span class="n">ARROW_ASSIGN_OR_RAISE</span><span class="p">(</span><span class="k">auto</span> <span class="n">codec</span><span class="p">,</span> <span class="n">Codec</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="n">Compression</span><span class="o">::</span><span class="n">GZIP</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>

<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span> <span class="n">compressed</span><span class="p">(</span><span class="n">max_compressed_len</span><span class="p">);</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span> <span class="n">decompressed</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
<span class="kt">int</span> <span class="n">max_compressed_len</span> <span class="o">=</span>
   <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">MaxCompressedLen</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">()));</span>

<span class="n">ARROW_ASSIGN_OR_RAISE</span><span class="p">(</span>
   <span class="k">auto</span> <span class="n">compressed_size</span><span class="p">,</span>
   <span class="n">codec</span><span class="o">-&gt;</span><span class="n">Compress</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">max_compressed_len</span><span class="p">,</span> <span class="n">compressed_data</span><span class="p">.</span><span class="n">data</span><span class="p">()));</span>

<span class="n">ARROW_ASSIGN_OR_RAISE</span><span class="p">(</span>
   <span class="k">auto</span> <span class="n">decompressed_size</span><span class="p">,</span>
   <span class="n">codec</span><span class="o">-&gt;</span><span class="n">Decompress</span><span class="p">(</span><span class="n">compressed</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">compressed</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">decompressed</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">decompressed</span><span class="p">.</span><span class="n">data</span><span class="p">()));</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="how-to-run-benchmark">
<h2>How to run benchmark<a class="headerlink" href="#how-to-run-benchmark" title="Permalink to this headline">¶</a></h2>
<p>Intel Codec Library provided two types of benchmarks:</p>
<ul class="simple">
<li>Benchmark for normal file</li>
<li>Benchmark for Parquet file</li>
</ul>
<div class="section" id="benchmark-for-normal-file">
<h3>Benchmark for normal file<a class="headerlink" href="#benchmark-for-normal-file" title="Permalink to this headline">¶</a></h3>
<p>This benchmark will read <code class="docutils literal notranslate"><span class="pre">Calgary</span> <span class="pre">corpus</span></code> data which commonly used for comparing data compression algorithms as input and use different compressors supported by Arrow to compress and decompress that data to benchmark different codec’s performance.</p>
<p>To run the benchmark following the below guide:</p>
<ol class="arabic">
<li><p class="first">Build Intel Codec Library with benchmark option on:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>mkdir build
<span class="nb">cd</span> build
cmake -DCMAKE_BUILD_TYPE<span class="o">=</span>Release -DBDTK_ENABLE_ICL<span class="o">=</span>ON -DICL_BUILD_BENCHMARKS<span class="o">=</span>ON -DBDTK_ENABLE_CIDER<span class="o">=</span>OFF ../cpp
cmake --build .
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="last simple">
<li>To build benchmark, you need build Arrow with ICL patch first, please see <a class="reference internal" href="#icl-arrow-reference-link"><span class="std std-ref">ICL Arrow Compression Codec API</span></a> for how to build Arrow.</li>
<li>Please see <span class="xref std std-ref">icl_building_the_library_reference_link</span> for how to customize your build and enable required backend.</li>
<li>Please make sure to turn on the option <code class="docutils literal notranslate"><span class="pre">-DICL_BUILD_BENCHMARKS=ON</span></code> when build</li>
<li>Please make sure build ICL with the correct Arrow package which build with ICL patch, you can set the environment <code class="docutils literal notranslate"><span class="pre">ARROW_HOME</span></code> to the folder where installed the Arrow with ICL patch.</li>
</ul>
</div>
</li>
<li><p class="first">Prepare the <code class="docutils literal notranslate"><span class="pre">Calgary</span> <span class="pre">corpus</span></code> data for benchmark
You can download the data from <a class="reference external" href="http://www.data-compression.info/files/corpora/largecalgarycorpus.zip">here</a>, then unzip it and tar these files to a tar file <code class="docutils literal notranslate"><span class="pre">calgary.tar</span></code></p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>unzip largecalgarycorpus.zip -d calgary
tar cvf calgary.tar calgary
</pre></div>
</div>
</li>
<li><p class="first">Copy the calgary.tar to folder where you run the CompressionBenchmark which generated in step 1.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="last simple">
<li>To enable ICL, you need set the environment <code class="docutils literal notranslate"><span class="pre">GZIP_BACKEND</span></code> when run the benchmark.</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="section" id="benchmark-for-parquet-file">
<h3>Benchmark for parquet file<a class="headerlink" href="#benchmark-for-parquet-file" title="Permalink to this headline">¶</a></h3>
<p>We use TPC-H lineitem table as the source to benchmark the parquet reader performance by reading all the columns in this table. Please follow the below steps to generate the Parquet file for TPC-H lineitem table and run the benchmark.</p>
<ol class="arabic">
<li><p class="first">Build Intel Codec Library with benchmark option on:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>mkdir build
<span class="nb">cd</span> build
cmake -DCMAKE_BUILD_TYPE<span class="o">=</span>Release -DBDTK_ENABLE_ICL<span class="o">=</span>ON -DICL_BUILD_BENCHMARKS<span class="o">=</span>ON -DBDTK_ENABLE_CIDER<span class="o">=</span>OFF ../cpp
cmake --build .
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="last simple">
<li>To build benchmark, you need build Arrow with ICL patch first, please see <a class="reference internal" href="#icl-arrow-reference-link"><span class="std std-ref">ICL Arrow Compression Codec API</span></a> for how to build Arrow.</li>
<li>Please see <span class="xref std std-ref">icl_building_the_library_reference_link</span> for how to customize your build and enable required backend.</li>
<li>Please make sure to turn on the option <code class="docutils literal notranslate"><span class="pre">-DICL_BUILD_BENCHMARKS=ON</span></code> when build</li>
<li>Please make sure build ICL with the correct Arrow package which build with ICL patch, you can set the environment <code class="docutils literal notranslate"><span class="pre">ARROW_HOME</span></code> to the folder where installed the Arrow with ICL patch.</li>
</ul>
</div>
</li>
<li><p class="first">Generate the Parquet file for TPC-H lineitem using the <code class="docutils literal notranslate"><span class="pre">TpchDataGen</span></code> tool, in your <code class="docutils literal notranslate"><span class="pre">build</span></code> directory, run the following command will generate parquet file <code class="docutils literal notranslate"><span class="pre">lineitem.igzip.parquet</span></code> with <code class="docutils literal notranslate"><span class="pre">igzip</span></code> backend with compression level one at TPC-H SF1.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>./TpchDataGen -s <span class="m">1</span> -c <span class="s1">&#39;igzip&#39;</span> -l <span class="m">1</span> -f lineitem.igzip.parquet
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="last simple">
<li>You can specify the backend use <code class="docutils literal notranslate"><span class="pre">-c</span></code> parameter, <code class="docutils literal notranslate"><span class="pre">-f</span></code> to specify the name for parquet file, <code class="docutils literal notranslate"><span class="pre">-l</span></code> to specify the compression level and <code class="docutils literal notranslate"><span class="pre">-s</span></code> to specify the scale factor for TPCH datagen.</li>
</ul>
</div>
</li>
<li><p class="first">Run the bechmark using the <code class="docutils literal notranslate"><span class="pre">ParquetBenchmark</span></code> tool. As a example, the following command will benchmark <code class="docutils literal notranslate"><span class="pre">igzip</span></code> backend for single thread which will run 10 iterations.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>./ParquetBenchmark -c <span class="s1">&#39;igzip&#39;</span> -f lineitem.igzip.parquet -i <span class="m">10</span> -t <span class="m">1</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="last simple">
<li>You can specify the backend use <code class="docutils literal notranslate"><span class="pre">-c</span></code> parameter, <code class="docutils literal notranslate"><span class="pre">-f</span></code> to specify the name for parquet file, <code class="docutils literal notranslate"><span class="pre">-i</span></code> to specify the iterations and <code class="docutils literal notranslate"><span class="pre">-t</span></code> to specify the threads run the benchmark.</li>
<li>Please make sure that the file specified by <code class="docutils literal notranslate"><span class="pre">-f</span></code> is generated by <code class="docutils literal notranslate"><span class="pre">-c</span></code> backend in step 2.</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="section" id="limitation">
<h2>Limitation<a class="headerlink" href="#limitation" title="Permalink to this headline">¶</a></h2>
<p>In order to take full advantage of hardware acceleration, Intel Codec Library only supports block-based interface for compression, aka “one shot”, so the data compressed by ICL can’t be decompressed by stream-based software like Gzip.</p>
</div>
<div class="section" id="to-be-add">
<h2>To Be Add<a class="headerlink" href="#to-be-add" title="Permalink to this headline">¶</a></h2>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Intel Codec Library User Guide</a><ul>
<li><a class="reference internal" href="#module-description">Module description</a></li>
<li><a class="reference internal" href="#sdk-api">SDK API</a></li>
<li><a class="reference internal" href="#building-the-library">Building the Library</a><ul>
<li><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li><a class="reference internal" href="#build">Build</a></li>
<li><a class="reference internal" href="#build-options">Build Options</a></li>
<li><a class="reference internal" href="#modular-build-target">Modular Build Target</a></li>
<li><a class="reference internal" href="#additional-requirements-for-qat-backend">Additional requirements for QAT backend</a></li>
<li><a class="reference internal" href="#additional-requirements-for-qpl-backend">Additional requirements for QPL backend</a></li>
<li><a class="reference internal" href="#additional-requirements-for-ipp-backend">Additional requirements for IPP backend</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use-intel-codec-library">How to use Intel Codec Library</a><ul>
<li><a class="reference internal" href="#icl-c-api">ICL C++ API</a></li>
<li><a class="reference internal" href="#icl-java-api">ICL JAVA API</a></li>
<li><a class="reference internal" href="#icl-arrow-compression-codec-api">ICL Arrow Compression Codec API</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-run-benchmark">How to run benchmark</a><ul>
<li><a class="reference internal" href="#benchmark-for-normal-file">Benchmark for normal file</a></li>
<li><a class="reference internal" href="#benchmark-for-parquet-file">Benchmark for parquet file</a></li>
</ul>
</li>
<li><a class="reference internal" href="#limitation">Limitation</a></li>
<li><a class="reference internal" href="#to-be-add">To Be Add</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="../modules.html"
                        title="previous chapter">Modules</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="expr-eval-module.html"
                        title="next chapter">Expression Evaluation Module Introduction</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/user/modules/ICL-module.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="expr-eval-module.html" title="Expression Evaluation Module Introduction"
             >next</a> |</li>
        <li class="right" >
          <a href="../modules.html" title="Modules"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Cider 1.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../user.html" >User Guide</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../modules.html" >Modules</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2022, Intel.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.
    </div>
  </body>
</html>